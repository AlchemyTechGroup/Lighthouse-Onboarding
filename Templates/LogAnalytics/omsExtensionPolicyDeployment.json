{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "rbacGuid": {
          "type": "string",
          "defaultValue": "[newGuid()]"
      },
      "ResourceGroupName": {
          "type": "string",
          "defaultValue": "rg-vm-lh-atg-images"
      },
      "workspaceKey": {
          "type": "securestring"
      },
      "policyParameters": {
          "type": "object",
          "metadata": {
              "displayName": "Policy parameters",
              "description": "Policy parameters as an object parameter type."
          },
          "defaultValue": { 
            "logAnalyticsWorkspaceID": {
              "value": "5fee8ab8-4ec2-473f-a28f-2438c38f54dc"
            },
            "logAnalyticsWorkspaceKey": {
              "value": "[parameters('workspaceKey')]"
            }
          }
      }
  },
  "variables": {
      "policyDefinitionName": "ATGLH Log Analytics Policy - Definition",
      "policyAssignmentName": "ATGLH Log Analytics Policy",
      "rbacContributor": "92aaf0da-9dab-42b6-94a3-d43ce8d16293",
      "ResourceGroup": "[parameters('ResourceGroupName')]"
  },
  "resources": [
      {
          "type": "Microsoft.Authorization/policyAssignments",
          "apiVersion": "2018-05-01",
          "name": "[variables('policyAssignmentName')]",
          "location": "southcentralus",
          "identity": {
              "type": "SystemAssigned"
          },
          "properties": {
              "description": "[variables('policyAssignmentName')]",
              "displayName": "[variables('policyAssignmentName')]",
              "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/', variables('policyDefinitionName'))]",
              "scope": "[concat(subscription().id, '/resourceGroups/',variables('ResourceGroup'))]",
              "metadata": {
                  "assignedBy": "ATG Cloud Center of Excellence"
              },
              "parameters": "[parameters('policyParameters')]"
          }
      },
      {
          "type": "Microsoft.Authorization/roleAssignments",
          "apiVersion": "2019-04-01-preview",
          "name": "[parameters('rbacGuid')]",
          "dependsOn": [
              "[variables('policyAssignmentName')]"
          ],
          "properties": {
              "roleDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/roleDefinitions/', variables('rbacContributor'))]",
              "principalType": "ServicePrincipal",
              "delegatedManagedIdentityResourceId": "[if(not(empty(subscription().managedByTenants)), concat(subscription().id, '/resourceGroups/', variables('ResourceGroup'), '/providers/Microsoft.Authorization/policyAssignments/', variables('policyAssignmentName')), json('null'))]",
              "principalId": "[toLower(reference(concat('/providers/Microsoft.Authorization/policyAssignments/', variables('policyAssignmentName')), '2018-05-01', 'Full' ).identity.principalId)]"
          }
      }
  ],
  "outputs": {
      "policyAssignmentId": {
      "type": "string",
      "value": "[if(not(empty(subscription().managedByTenants)), concat(subscription().id, '/resourceGroups/', variables('ResourceGroup'), '/providers/Microsoft.Authorization/policyAssignments/', variables('policyAssignmentName')), json('null'))]"
      }
  }
}